<div class="page stack">
  <div class="page-header">
    <div>
      <h1 class="page-title">Transactions</h1>
      <p class="page-subtitle">Add spending and review history.</p>
    </div>
  </div>

  <!-- Filter bar -->
  <div class="surface" style="margin-bottom: 12px;">
    <div class="row-between">
      <h3 class="section-title" style="margin: 0;">Filters</h3>
      <button class="btn" type="button" (click)="clearFilters()">Clear</button>
    </div>

    <div class="form-grid">
      <mat-form-field appearance="outline">
        <mat-label>Start date</mat-label>
        <input
          matInput
          type="date"
          [(ngModel)]="filters.startDate"
          (ngModelChange)="onFiltersChanged()"
          name="startDate"
        />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>End date</mat-label>
        <input
          matInput
          type="date"
          [(ngModel)]="filters.endDate"
          (ngModelChange)="onFiltersChanged()"
          name="endDate"
        />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Category</mat-label>
        <mat-select
          [(ngModel)]="filters.categoryId"
          (ngModelChange)="onFiltersChanged()"
          name="filterCategoryId"
        >
          <mat-option value="">All</mat-option>
          <mat-option *ngFor="let c of categories" [value]="c.id">
            {{ c.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Search by name</mat-label>
        <input
          matInput
          [(ngModel)]="filters.search"
          (ngModelChange)="onFiltersChanged()"
          name="search"
        />
      </mat-form-field>
    </div>
  </div>

  <!-- Pills -->
  <div class="pills">
    <div class="pill">
      <span>Count</span>
      <strong>{{ filteredTransactions.length }}</strong>
    </div>

    <div class="pill">
      <span>Income</span>
      <strong>{{ incomeTotal | currency }}</strong>
    </div>

    <div class="pill">
      <span>Expenses</span>
      <strong>{{ expenseTotal | currency }}</strong>
    </div>

    <div class="pill">
      <span>Net</span>
      <strong>{{ netBalance | currency }}</strong>
    </div>
  </div>

  <!-- Add transaction -->
  <mat-accordion>
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>Add transaction</mat-panel-title>
        <mat-panel-description>Tap to open</mat-panel-description>
      </mat-expansion-panel-header>

      <div class="form-grid">
        <mat-form-field appearance="outline" class="span-1">
          <mat-label>Date</mat-label>
          <input matInput type="date" [(ngModel)]="form.date" name="date" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="span-1">
          <mat-label>Amount</mat-label>
          <input
            matInput
            type="number"
            step="0.01"
            [(ngModel)]="form.amount"
            name="amount"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="span-1">
          <mat-label>Category</mat-label>
          <mat-select [(ngModel)]="form.categoryId" name="categoryId">
            <mat-option *ngFor="let c of categories" [value]="c.id">
              {{ c.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="span-1">
          <mat-label>Payment method</mat-label>
          <mat-select [(ngModel)]="form.paymentMethod" name="paymentMethod">
            <mat-option *ngFor="let pm of paymentMethods" [value]="pm.value">
              {{ pm.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="span-4">
          <mat-label>Description</mat-label>
          <input matInput [(ngModel)]="form.description" name="description" />
        </mat-form-field>

        <div class="span-4">
          <mat-checkbox [(ngModel)]="form.isRecurringInstance" name="isRecurringInstance">
            This is a recurring instance
          </mat-checkbox>
        </div>
      </div>

      <div class="row-end">
        <button mat-flat-button color="primary" (click)="add()">Add</button>
      </div>
    </mat-expansion-panel>
  </mat-accordion>

  <!-- Table -->
  <mat-card>
    <div class="section-title">Recent</div>

    <div class="table-wrap">
      <table class="table" *ngIf="filteredTransactions.length > 0; else empty">
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Description</th>
            <th>Method</th>
            <th>Recurring?</th>
            <th class="text-right">Amount</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let t of filteredTransactions; trackBy: trackById">
            <td>{{ t.date | date:'MM/dd/yyyy' }}</td>
            <td>{{ categoryName(t.categoryId) }}</td>
            <td>{{ t.description || '-' }}</td>
            <td>{{ t.paymentMethod }}</td>
            <td>{{ t.isRecurringInstance ? 'Yes' : 'No' }}</td>
            <td class="text-right">{{ t.amount | currency }}</td>
            <td class="text-right">
              <button mat-stroked-button color="warn" (click)="delete(t.id)">
                Delete
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <ng-template #empty>
      <p class="text-muted">No transactions match your filters.</p>
    </ng-template>
  </mat-card>
</div>
